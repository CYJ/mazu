# -*- cofing: utf-8 -*-
import os

from django.test import Client
from django.test import TestCase

from django.core.urlresolvers import reverse_lazy

from core.tests import random_string
from core.mongodb import connect_gridfs

from .models import Malware


def random_file():
    app_path = os.path.dirname(__file__)
    tests_folder = os.path.join(app_path, 'tests')
    if not os.path.exists(tests_folder):
        os.mkdir(tests_folder)

    path = os.path.join(app_path, 'tests', random_string(10))
    fp = open(path, 'wb')
    fp.write(random_string(10))
    fp.close()
    return path


class MalwareTestCase(TestCase):

    def setUp(self):
        self.client = Client()
        self.file_path = random_file()
        self.file_name = random_string(8)

    def _upload(self, file_path, file_name):
        with open(file_path, 'rb') as fp:
            response = self.client.post(
                reverse_lazy('malware_upload'),
                {
                    'name': file_name,
                    'malware': fp,
                    'description': random_string(),
                }
            )
            return response

    def test_can_upload(self):
        # test can upload
        cond = {'filename': self.file_name}
        gridfs = connect_gridfs()
        excepted_count = gridfs.find(cond).count() + 1
        self._upload(self.file_path, self.file_name)
        count = gridfs.find(cond).count()
        self.assertEqual(count, excepted_count)

        # test can not upload repeatedly
        messages = list()
        excepted_message = 'Duplicated Malware Sample.'
        response = self._upload(self.file_path, self.file_name)
        for obj in response.context['messages']:
            messages.append(obj.message)
        self.assertIn(excepted_message, messages)

    def test_list_view(self):
        self._upload(self.file_path, self.file_name)
        malwares = Malware.objects.all()
        response = self.client.get(reverse_lazy('malware_list'))
        self.assertEqual(response.status_code, 200)
        for mal in response.context['malwares']:
            self.assertIn(mal, malwares)

    def test_profile_view(self):
        self._upload(self.file_path, self.file_name)
        malware = Malware.objects.get(name=self.file_name)
        response = self.client.get(
            reverse_lazy('malware_profile', args=[malware.sha512])
        )
        self.assertEqual(response.context['malware'], malware)

    def test_can_update(self):
        self._upload(self.file_path, self.file_name)
        malware = Malware.objects.get(name=self.file_name)
        new_file_name = random_string(8)
        response = self.client.post(
            reverse_lazy('malware_update', args=[malware.sha512]),
            {
                'name': new_file_name,
                'type': malware.type,
                'size': malware.size,
                'crc32': malware.crc32,
                'md5': malware.md5,
                'sha1': malware.sha1,
                'sha256': malware.sha256,
                'sha512': malware.sha512,
                'ssdeep': malware.ssdeep,
            }
        )
        try:
            Malware.objects.get(name=new_file_name)
        except Malware.DoesNotExist:
            updated = False
        else:
            updated = True
        self.assertTrue(updated)

    def test_can_delete(self):
        self._upload(self.file_path, self.file_name)
        malware = Malware.objects.get(name=self.file_name)
        self.client.post(
            reverse_lazy('malware_delete', args=[malware.sha512]),
            {
                'pk': malware.id
            }
        )
        try:
            Malware.objects.get(name=self.file_name)
        except Malware.DoesNotExist:
            does_exist = False
        else:
            does_exist = True
        self.assertFalse(does_exist)
