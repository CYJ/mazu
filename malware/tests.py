#! -*- cofing: utf-8 -*-
import os

from django.test import Client
from django.test import TestCase

from django.core.urlresolvers import reverse_lazy

from core.mongodb import connect_gridfs


class MalwareTestCase(TestCase):

    def setUp(self):
        self.clt = Client()

    def generate_file(self):
        filepath = os.path.join(os.path.dirname(__file__), 'tests', 'test.txt')
        try:
            fp = open(filepath, 'wb')
            fp.write('HelloWorld')
        finally:
            fp.close()
        return filepath

    def test_can_upload(self):
        testfile = self.generate_file()
        gridfs = connect_gridfs()
        except_count = gridfs.find({'filename': 'test.txt'}).count() + 1

        with open(testfile, 'rb') as fp:
            self.clt.post(
                reverse_lazy('malware_upload'),
                {
                    'name': 'test.txt',
                    'malware': fp,
                    'description': 'test_upload'
                }
            )

        count = gridfs.find({'filename': 'test.txt'}).count()
        self.assertEqual(count, except_count)
