# -*- coding: utf-8 -*-
import logging
import hashlib
import binascii

import magic
import ssdeep

from core.mongodb import connect_gridfs
from models import Malware


logger = logging.getLogger(__name__)


def compute_hashes(buf):
    """ Compute hashes

    >>> compute_hashes('HelloWorld')
    """
    algorithms = ('md5', 'sha1', 'sha256', 'sha512')
    hashes = dict()
    for a in algorithms:
        hashes[a] = getattr(hashlib, a)(buf).hexdigest()
    return hashes


def compute_ssdeep(buf):
    """ Compute ssdeep

    >>> compute_ssdeep('HelloWorld')
    """
    return ssdeep.hash(buf)


def get_uploaded_file_info(fp):
    """ Get information of Django InMemoryUploadedFile
    """
    file_info = dict()
    try:
        buf = fp.read()
    except Exception as e:
        logger.debug(e)
        raise
    else:
        file_info.update(compute_hashes(buf))
        file_info.update({
            'size': getattr(fp, 'size', None),
            'type': magic.from_buffer(buf),
            'crc32': binascii.crc32(buf),
            'ssdeep': compute_ssdeep(buf),
        })
        return file_info


def save_malware(buf):
    hashes = compute_hashes(buf)
    try:
        Malware.objects.get(sha256=hashes['sha256'])
    except Malware.DoesNotExist as e:
        malware_exist = False
    except Exception as e:
        malware_exist = False
    else:
        malware_exist = True

    if not malware_exist:
        columns = dict()
        columns.update(hashes)
        columns.update({
            'size': str(len(buf)), # bytes
            'type': magic.from_buffer(str(buf)),
            'crc32': binascii.crc32(buf),
            'ssdeep': compute_ssdeep(str(buf))
        })
        # save malware into gridfs
        try:
            gridfs = connect_gridfs()
        except:
            return False
        else:
            with gridfs.new_file() as fp:
                fp.write(str(buf))

                for attr, value in columns.items():
                    if attr != 'md5':
                        setattr(fp, attr, value)
                fp.close()
                instance = Malware(**columns)
                instance.save()
            return True
